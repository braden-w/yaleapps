---
import { addedCommentSentimentColumnNames, db } from '@repo/db/courses'
import Layout from '../layouts/Layout.astro'
import { CoursesDataTable } from './_courses/CoursesDataTable'

type Year = `${number}${number}${number}${number}`
type Season = '01' | '02' | '03'
type SeasonCode = `${Year}${Season}`
type ColumnName = (typeof addedCommentSentimentColumnNames)[number]

export async function getStaticPaths() {
	const allSeasons = await db.query.seasons.findMany()
	return Promise.all(
		allSeasons.map(async ({ season_code, term, year }) => {
			const allCourses = await db.query.courses.findMany({
				where: (courses, { eq }) => eq(courses.season_code, season_code),
				columns: {
					title: true,
					description: true,
					areas: true,
					skills: true,
					season_code: true,
					credits: true,
					last_enrollment: true,
					average_rating: true,
					average_workload: true,
					average_comment_compound: true,
				},
				with: {
					listings: {
						columns: {
							subject: true,
							section: true,
						},
					},
				},
				limit: 10,
			})
			return {
				params: {
					season_code,
					year,
					term,
				},
				props: {
					allCourses,
				},
			}
		}),
	)
}

const { season_code, year, term } = Astro.params
const { allCourses } = Astro.props
---

<Layout>
	<CoursesDataTable courses={allCourses} client:load />
</Layout>
